<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Campus Life Assistant - UGM</title>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            opacity: 0.9;
        }

        .main-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
        }

        .menu-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .menu-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .menu-card p {
            color: #666;
            font-size: 0.9em;
        }

        .content-area {
            padding: 30px;
            display: none;
        }

        .content-area.active {
            display: block;
        }

        .back-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 1em;
        }

        .back-btn:hover {
            background: #5568d3;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin-right: 10px;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .list-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .list-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .list-item p {
            color: #666;
            margin: 5px 0;
        }

        .chart-container {
            margin-top: 30px;
        }

        .chart-bar {
            margin-bottom: 15px;
        }

        .chart-label {
            display: inline-block;
            width: 150px;
            font-weight: 500;
        }

        .chart-bar-fill {
            display: inline-block;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 30px;
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .chart-value {
            display: inline-block;
            margin-left: 10px;
            color: #666;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        a {
            text-decoration: none;
        }

        .difficulty-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }

        .difficulty-easy {
            background: #d4edda;
            color: #155724;
        }

        .difficulty-medium {
            background: #fff3cd;
            color: #856404;
        }

        .difficulty-hard {
            background: #f8d7da;
            color: #721c24;
        }

        .time-slot {
            background: #e8f4f8;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .gpa-result {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
        }

        .gpa-result h2 {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .course-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
</style>
</head>
<body>
    <div class="container">
        <!-- Login/Register Screen -->
        <div id="authScreen" style="display: none;">
            <div class="header">
                <h1>üéì Campus Life Assistant</h1>
                <p>Silakan login atau daftar untuk melanjutkan</p>
            </div>
            <div style="padding: 40px; max-width: 500px; margin: 0 auto;">
                <div id="loginForm">
                    <h2 style="color: #667eea; margin-bottom: 20px;">Login</h2>
                    <div class="form-group">
                        <label>Username</label>
                        <input 
                        type="email"
                        id="loginUsername"
                        placeholder="contoh@gmail.com"
                        pattern="^[a-zA-Z0-9._%+-]+@gmail\.com$"
                        title="Harus menggunakan akun Gmail (@gmail.com)"
                        required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input 
                        type="password"
                        id="loginPassword"
                        placeholder="Masukkan password minimal 6 karakter"
                        required>
                    </div>
                    <button class="btn" onclick="login()" style="width: 100%;">Login</button>
                    <p style="text-align: center; margin-top: 15px;">Belum punya akun? <a href="#" onclick="showRegister(); return false;" style="color: #667eea; font-weight: bold;">Daftar disini</a></p>
                </div>

                <div id="registerForm" style="display: none;">
                    <h2 style="color: #667eea; margin-bottom: 20px;">Daftar Akun Baru</h2>
                    <div class="form-group">
                        <label>Nama Lengkap</label>
                        <input 
                        type="text"
                        id="registerName"
                        placeholder="Masukkan nama lengkap"
                        required>
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input 
                        type="email"
                        id="registerUsername"
                        placeholder="contoh@gmail.com"
                        pattern="^[a-zA-Z0-9._%+-]+@gmail\.com$"
                        title="Harus menggunakan akun Gmail (@gmail.com)"
                        required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input
                        type="password"
                        id="registerPassword"
                        placeholder="Minimal 6 karakter"
                        minlength="6"
                        title="Password minimal 6 karakter"
                        required>
                    </div>
                    <div class="form-group">
                        <label>Konfirmasi Password</label>
                        <input 
                        type="password"
                        id="registerConfirmPassword"
                        placeholder="Ulangi password"
                        minlength="6"
                        required>
                    </div>
                    <button class="btn" onclick="register()" style="width: 100%;">Daftar</button>
                    <p style="text-align: center; margin-top: 15px;">Sudah punya akun? <a href="#" onclick="showLogin(); return false;" style="color: #667eea; font-weight: bold;">Login disini</a></p>
                </div>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" style="display: none;">
            <div class="header">
                <h1>üéì Campus Life Assistant</h1>
                <p>Sistem Manajemen Personal Mahasiswa</p>
                <div style="margin-top: 10px;">
                    <span id="userGreeting" style="font-size: 0.9em;"></span>
                    <button class="btn" onclick="logout()" style="padding: 5px 15px; font-size: 0.9em; margin-left: 10px;">Logout</button>
                </div>
            </div>

            <div id="mainMenu" class="main-menu">
                <div class="menu-card" onclick="showSection('academic')">
                    <div class="icon">üìö</div>
                    <h3>Academic Tools</h3>
                    <p>Kelola catatan dan jadwal belajar</p>
                </div>
                <div class="menu-card" onclick="showSection('studentLife')">
                    <div class="icon">üí∞</div>
                    <h3>Student Life Tools</h3>
                    <p>Pengeluaran dan tugas pribadi</p>
                </div>
                <div class="menu-card" onclick="showSection('reports')">
                    <div class="icon">üìä</div>
                    <h3>Reports & Insights</h3>
                    <p>Lihat laporan produktivitas</p>
                </div>
                <div class="menu-card" onclick="showSection('reminders')">
                    <div class="icon">üîî</div>
                    <h3>Reminders</h3>
                    <p>Kelola pengingat tugas</p>
                </div>
                <div class="menu-card" onclick="showSection('settings')">
                    <div class="icon">‚öôÔ∏è</div>
                    <h3>Settings</h3>
                    <p>Pengaturan aplikasi</p>
                </div>
            </div>

            <!-- Academic Tools -->
            <div id="academic" class="content-area">
                <button class="back-btn" onclick="showMain()">‚Üê Kembali</button>
                <h2>Academic Tools</h2>
                <div class="main-menu">
                    <div class="menu-card" onclick="showSubSection('notes')">
                        <h3>üìù Notes Manager</h3>
                        <p>Kelola catatan kuliah</p>
                    </div>
                    <div class="menu-card" onclick="showSubSection('study')">
                        <h3>üìÖ Study Planner</h3>
                        <p>Rencanakan sesi belajar</p>
                    </div>
                    <div class="menu-card" onclick="showSubSection('autoSchedule')">
                        <h3>ü§ñ Auto-Schedule</h3>
                        <p>Jadwal belajar otomatis</p>
                    </div>
                    <div class="menu-card" onclick="showSubSection('gpaCalc')">
                        <h3>üéØ GPA Calculator</h3>
                        <p>Hitung IPK semester</p>
                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div id="notes" class="content-area">
                <button class="back-btn" onclick="showSection('academic')">‚Üê Kembali</button>
                <h2>üìù Notes Manager</h2>
                <div class="form-group"><label>Subjek</label><input type="text" id="noteSubject"></div>
                <div class="form-group"><label>Isi Catatan</label><textarea id="noteContent" rows="4"></textarea></div>
                <div class="form-group"><label>Tanggal</label><input type="date" id="noteDate"></div>
                <button class="btn" onclick="addNote()">Tambah Catatan</button>
                <h3 style="margin-top: 30px;">Daftar Catatan</h3>
                <div id="notesList"></div>
            </div>

            <!-- Study -->
            <div id="study" class="content-area">
                <button class="back-btn" onclick="showSection('academic')">‚Üê Kembali</button>
                <h2>üìÖ Study Planner</h2>
                <div class="form-group"><label>Subjek</label><input type="text" id="studySubject"></div>
                <div class="form-group"><label>Tanggal</label><input type="date" id="studyDate"></div>
                <div class="form-group"><label>Jam Belajar</label><input type="number" id="studyHours" step="0.5"></div>
                <button class="btn" onclick="addStudySession()">Tambah Sesi</button>
                <h3 style="margin-top: 30px;">Daftar Sesi Belajar</h3>
                <div id="studyList"></div>
            </div>

            <!-- Auto-Schedule Study Blocks -->
            <div id="autoSchedule" class="content-area">
                <button class="back-btn" onclick="showSection('academic')">‚Üê Kembali</button>
                <h2>ü§ñ Auto-Schedule Study Blocks</h2>
                <p style="color: #666; margin-bottom: 20px;">Sistem akan membuat jadwal belajar otomatis berdasarkan tugas yang belum selesai dan waktu yang tersedia.</p>
                
                <div class="form-group">
                    <label>Hari Mulai</label>
                    <input type="date" id="scheduleStartDate">
                </div>
                <div class="form-group">
                    <label>Hari Selesai</label>
                    <input type="date" id="scheduleEndDate">
                </div>
                <div class="form-group">
                    <label>Jam Belajar per Hari (Maksimal)</label>
                    <input type="number" id="maxHoursPerDay" value="4" step="0.5" min="0.5" max="12">
                </div>
                <div class="form-group">
                    <label>Durasi Sesi Belajar (Jam)</label>
                    <select id="sessionDuration">
                        <option value="1">1 jam</option>
                        <option value="1.5">1.5 jam</option>
                        <option value="2" selected>2 jam</option>
                        <option value="2.5">2.5 jam</option>
                        <option value="3">3 jam</option>
                    </select>
                </div>
                
                <button class="btn btn-success" onclick="generateAutoSchedule()">üöÄ Buat Jadwal Otomatis</button>
                
                <div id="autoScheduleResult" style="margin-top: 30px;"></div>
            </div>

            <!-- GPA Calculator -->
            <div id="gpaCalc" class="content-area">
                <button class="back-btn" onclick="showSection('academic')">‚Üê Kembali</button>
                <h2>üéØ GPA Calculator</h2>
                <p style="color: #666; margin-bottom: 20px;">Hitung IPK semester Anda dengan mudah</p>
                
                <div id="coursesContainer"></div>
                
                <button class="btn" onclick="addCourseRow()">+ Tambah Mata Kuliah</button>
                <button class="btn btn-success" onclick="calculateGPA()">üìä Hitung IPK</button>
                <button class="btn btn-danger" onclick="clearGPAForm()">üóëÔ∏è Reset</button>
                
                <div id="gpaResult"></div>
            </div>

            <!-- Student Life -->
            <div id="studentLife" class="content-area">
                <button class="back-btn" onclick="showMain()">‚Üê Kembali</button>
                <h2>Student Life Tools</h2>
                <div class="main-menu">
                    <div class="menu-card" onclick="showSubSection('expense')"><h3>üí≥ Expense Tracker</h3><p>Lacak pengeluaran</p></div>
                    <div class="menu-card" onclick="showSubSection('tasks')"><h3>‚úÖ Task Organizer</h3><p>Organisir tugas</p></div>
                </div>
            </div>

            <!-- Expense -->
            <div id="expense" class="content-area">
                <button class="back-btn" onclick="showSection('studentLife')">‚Üê Kembali</button>
                <h2>üí≥ Expense Tracker</h2>
                <div class="form-group"><label>Tanggal</label><input type="date" id="expenseDate"></div>
                <div class="form-group">
                    <label>Kategori</label>
                    <select id="expenseCategory">
                        <option value="Food">Food</option>
                        <option value="Rent">Rent</option>
                        <option value="Study">Study</option>
                        <option value="Travel">Travel</option>
                    </select>
                </div>
                <div class="form-group"><label>Jumlah (Rp)</label><input type="number" id="expenseAmount"></div>
                <button class="btn" onclick="addExpense()">Tambah Pengeluaran</button>
                <h3 style="margin-top: 30px;">Visualisasi Pengeluaran</h3>
                <div id="expenseChart" class="chart-container"></div>
                <h3 style="margin-top: 30px;">Daftar Pengeluaran</h3>
                <div id="expenseList"></div>
            </div>

            <!-- Tasks -->
            <div id="tasks" class="content-area">
                <button class="back-btn" onclick="showSection('studentLife')">‚Üê Kembali</button>
                <h2>‚úÖ Personal Task Organizer</h2>
                <div class="form-group"><label>Judul Tugas</label><input type="text" id="taskTitle"></div>
                <div class="form-group"><label>Tenggat</label><input type="date" id="taskDeadline"></div>
                <div class="form-group">
                    <label>Estimasi Kesulitan</label>
                    <select id="taskDifficulty">
                        <option value="">Pilih tingkat kesulitan...</option>
                        <option value="easy">Mudah (1-2 jam)</option>
                        <option value="medium">Sedang (2-4 jam)</option>
                        <option value="hard">Sulit (4+ jam)</option>
                    </select>
                </div>
                <button class="btn" onclick="addTask()">Tambah Tugas</button>
                <h3 style="margin-top: 30px;">Daftar Tugas</h3>
                <div id="tasksList"></div>
            </div>

            <!-- Reports -->
            <div id="reports" class="content-area">
                <button class="back-btn" onclick="showMain()">‚Üê Kembali</button>
                <h2>üìä Laporan Mingguan</h2>
                <div class="stats-grid" id="reportStats"></div>
            </div>

            <!-- Reminders -->
            <div id="reminders" class="content-area">
                <button class="back-btn" onclick="showMain()">‚Üê Kembali</button>
                <h2>üîî Pengingat Tugas</h2>
                <div class="form-group"><label>Judul Pengingat</label><input type="text" id="reminderTitle"></div>
                <div class="form-group"><label>Tanggal & Waktu</label><input type="datetime-local" id="reminderDateTime"></div>
                <div class="form-group"><label>Catatan</label><textarea id="reminderNote" rows="3"></textarea></div>
                <button class="btn" onclick="addReminder()">Tambah Pengingat</button>
                <h3 style="margin-top: 30px;">Daftar Pengingat Aktif</h3>
                <div id="remindersList"></div>
            </div>

            <!-- Settings -->
            <div id="settings" class="content-area">
                <button class="back-btn" onclick="showMain()">‚Üê Kembali</button>
                <h2>‚öôÔ∏è Settings</h2>
                <div class="form-group"><label>Nama Pengguna</label><input type="text" id="userName" readonly></div>
                <div class="form-group"><label>Mata Uang</label><select id="currency"><option value="IDR">IDR</option><option value="USD">USD</option><option value="EUR">EUR</option></select></div>
                <div class="form-group"><label>Aktifkan Notifikasi</label><button class="btn" onclick="enableNotifications()">Izinkan Notifikasi</button><p>Status: <span id="notifStatus">Belum diaktifkan</span></p></div>
                <button class="btn" onclick="saveSettings()">Simpan Pengaturan</button>
                <button class="btn" onclick="backupData()">Backup Data</button>
                <button class="btn btn-danger" onclick="clearAllData()">Hapus Semua Data</button>
            </div>

            
        </div>
    </div>

    <script>
        (() => {
  let users = JSON.parse(localStorage.getItem('users')) || {};
  let currentUser = localStorage.getItem('currentUser') || null;

  let notes = [];
  let studySessions = [];
  let expenses = [];
  let tasks = [];
  let reminders = [];

  const reminderTimeouts = new Map();

  function ensureAuth() {
    if (!currentUser || !users[currentUser]) {
      alert('Silakan login terlebih dahulu.');
      showAuthScreen();
      return false;
    }
    return true;
  }

  function saveUsersToStorage() {
    localStorage.setItem('users', JSON.stringify(users));
  }

  function syncToUserData() {
    if (!ensureAuth()) return;
    users[currentUser].data = {
      notes,
      studySessions,
      expenses,
      tasks,
      reminders
    };
    saveUsersToStorage();
  }

  function loadFromUserData() {
    if (!ensureAuth()) return;
    const data = users[currentUser].data || {};
    notes = Array.isArray(data.notes) ? data.notes : [];
    studySessions = Array.isArray(data.studySessions) ? data.studySessions : [];
    expenses = Array.isArray(data.expenses) ? data.expenses : [];
    tasks = Array.isArray(data.tasks) ? data.tasks : [];
    reminders = Array.isArray(data.reminders) ? data.reminders : [];
  }

  function formatDate(dateStr) {
    try {
      const d = new Date(dateStr);
      return d.toLocaleDateString('id-ID') + ' ' + d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    } catch (e) {
      return dateStr;
    }
  }

  function formatCurrency(amount) {
    return amount.toLocaleString('id-ID');
  }

  function checkAuth() {
    if (currentUser && users[currentUser]) {
      loadFromUserData();
      showApp();
      rescheduleAllReminders();
    } else {
      showAuthScreen();
    }
  }

  function showAuthScreen() {
    document.getElementById('authScreen').style.display = 'block';
    document.getElementById('mainApp').style.display = 'none';
    showLogin();
  }

  function showApp() {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('userGreeting').textContent = users[currentUser].name ? `Halo, ${users[currentUser].name}! üëã` : 'Halo!';
    document.getElementById('userName').value = users[currentUser].name || '';
    document.getElementById('mainMenu').style.display = 'grid';
    document.querySelectorAll('.content-area').forEach(el => el.classList.remove('active'));
    displayNotes();
    displayStudySessions();
    displayExpenses();
    displayTasks();
    displayReminders();
    updateReport();
    checkNotificationPermission();
  }

  function showMain() {
    document.querySelectorAll('.content-area').forEach(el => el.classList.remove('active'));
    document.getElementById('mainMenu').style.display = 'grid';
  }

  function showSection(section) {
    document.getElementById('mainMenu').style.display = 'none';
    document.querySelectorAll('.content-area').forEach(el => el.classList.remove('active'));
    const el = document.getElementById(section);
    if (el) el.classList.add('active');
    if (section === 'reports') updateReport();
    if (section === 'notes') displayNotes();
    if (section === 'study') displayStudySessions();
    if (section === 'expense') { displayExpenses(); displayExpenseChart(); }
    if (section === 'tasks') displayTasks();
    if (section === 'reminders') displayReminders();
    if (section === 'gpaCalc') initGPACalculator();
  }

  function showSubSection(section) {
    showSection(section);
  }

  function showLogin() {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('registerForm').style.display = 'none';
  }
  
  function showRegister() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
  }



// ================================
// REGISTER
// ================================
function register() {
  const name = document.getElementById('registerName').value.trim();
  const username = document.getElementById('registerUsername').value.trim();
  const password = document.getElementById('registerPassword').value;
  const confirmPassword = document.getElementById('registerConfirmPassword').value;

  if (!name || !username || !password || !confirmPassword) {
    alert('Mohon lengkapi semua field!');
    return;
  }

  // Validasi Gmail
  const gmailRegex = /^[a-zA-Z0-9._%+-]+@gmail\.com$/;
  if (!gmailRegex.test(username)) {
    alert('Username harus menggunakan akun Gmail (@gmail.com)!');
    return;
  }

  // Validasi password
  if (password.length < 6) {
    alert('Password minimal 6 karakter!');
    return;
  }

  if (password !== confirmPassword) {
    alert('Password tidak cocok!');
    return;
  }

  if (users[username]) {
    alert('Username sudah digunakan!');
    return;
  }

  // Simpan ke database
  users[username] = {
    name: name,
    password: password,
    createdAt: new Date().toISOString(),
    data: {
      notes: [],
      studySessions: [],
      expenses: [],
      tasks: [],
      reminders: []
    }
  };

  saveUsersToStorage();

  alert('Registrasi berhasil! Silakan login.');

  document.getElementById('registerName').value = '';
  document.getElementById('registerUsername').value = '';
  document.getElementById('registerPassword').value = '';
  document.getElementById('registerConfirmPassword').value = '';

  showLogin();
}

// ================================
// LOGIN
// ================================
function login() {
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;

  if (!username || !password) {
    alert('Mohon masukkan username dan password!');
    return;
  }

  if (!users[username]) {
    alert('Username tidak ditemukan!');
    return;
  }

  if (users[username].password !== password) {
    alert('Password salah!');
    return;
  }

  currentUser = username;
  localStorage.setItem('currentUser', currentUser);

  document.getElementById('loginUsername').value = '';
  document.getElementById('loginPassword').value = '';

  showApp();
}

// ================================
// LOGOUT
// ================================
function logout() {
  if (!currentUser) return;

  if (confirm('Yakin ingin logout?')) {
    currentUser = null;
    localStorage.removeItem('currentUser');
    showAuthScreen();
  }
}

// ================================
// AUTO LOGIN SAAT REFRESH
// ================================
window.addEventListener('load', () => {
  if (currentUser && users[currentUser]) {
    showApp();
  } else {
    showAuthScreen();
  }
});

  
  

  function saveAllAndClearTimeouts() {
    if (currentUser) syncToUserData();
    reminderTimeouts.forEach((id) => clearTimeout(id));
    reminderTimeouts.clear();
  }

  let notificationPermission = false;

  async function enableNotifications() {
    if (!('Notification' in window)) {
      alert('Browser Anda tidak mendukung notifikasi!');
      return;
    }
    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
      notificationPermission = true;
      document.getElementById('notifStatus').textContent = '‚úÖ Aktif';
      new Notification('Campus Life Assistant', { body: 'Notifikasi berhasil diaktifkan!' });
    } else {
      alert('Izin notifikasi ditolak. Anda dapat mengaktifkannya di pengaturan browser.');
    }
  }

  function checkNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'granted') {
      notificationPermission = true;
      document.getElementById('notifStatus').textContent = '‚úÖ Aktif';
    } else {
      document.getElementById('notifStatus').textContent = 'Belum diaktifkan';
    }
  }

  function scheduleReminder(reminder) {
    if (reminderTimeouts.has(reminder.id)) {
      clearTimeout(reminderTimeouts.get(reminder.id));
      reminderTimeouts.delete(reminder.id);
    }

    if (!reminder.active) return;

    const now = Date.now();
    const target = new Date(reminder.dateTime).getTime();
    const delay = target - now;

    if (delay <= 0) {
      reminder.active = false;
      syncToUserData();
      displayReminders();
      return;
    }

    const timeoutId = setTimeout(() => {
      try {
        if (notificationPermission && 'Notification' in window) {
          new Notification(`üîî ${reminder.title}`, {
            body: reminder.note || 'Waktunya mengerjakan tugas ini!',
            requireInteraction: true
          });
        }
      } catch (e) {}
      alert(`üîî PENGINGAT!\n\n${reminder.title}\n\n${reminder.note || 'Waktunya mengerjakan tugas ini!'}`);
      reminder.active = false;
      if (reminderTimeouts.has(reminder.id)) {
        reminderTimeouts.delete(reminder.id);
      }
      syncToUserData();
      displayReminders();
    }, delay);

    reminderTimeouts.set(reminder.id, timeoutId);
  }

  function rescheduleAllReminders() {
    reminderTimeouts.forEach((id) => clearTimeout(id));
    reminderTimeouts.clear();

    if (!Array.isArray(reminders)) return;
    reminders.forEach(r => {
      if (r.active) scheduleReminder(r);
    });
  }

  function addReminder() {
    if (!ensureAuth()) return;
    const title = document.getElementById('reminderTitle').value.trim();
    const dateTime = document.getElementById('reminderDateTime').value;
    const note = document.getElementById('reminderNote').value.trim();

    if (!title || !dateTime) {
      alert('Mohon lengkapi judul dan waktu pengingat!');
      return;
    }
    const reminderTime = new Date(dateTime).getTime();
    if (isNaN(reminderTime) || reminderTime <= Date.now()) {
      alert('Waktu pengingat harus di masa depan!');
      return;
    }

    const reminder = { id: Date.now(), title, dateTime, note, active: true };
    reminders.push(reminder);
    syncToUserData();
    scheduleReminder(reminder);
    displayReminders();

    document.getElementById('reminderTitle').value = '';
    document.getElementById('reminderDateTime').value = '';
    document.getElementById('reminderNote').value = '';
    alert('Pengingat berhasil ditambahkan!');
  }

  function displayReminders() {
    if (!ensureAuth()) return;
    const list = document.getElementById('remindersList');
    const activeReminders = reminders.filter(r => r.active);
    if (activeReminders.length === 0) {
      list.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Belum ada pengingat aktif</p>';
      return;
    }
    const now = Date.now();
    list.innerHTML = activeReminders.map(reminder => {
      const reminderTime = new Date(reminder.dateTime);
      const timeLeftMs = reminderTime.getTime() - now;
      const hoursLeft = Math.floor(timeLeftMs / (1000 * 60 * 60));
      const minutesLeft = Math.floor((timeLeftMs % (1000 * 60 * 60)) / (1000 * 60));
      return `
        <div class="list-item">
          <h4>üîî ${escapeHtml(reminder.title)}</h4>
          <p>üìÖ ${reminderTime.toLocaleDateString('id-ID')} | ‚è∞ ${reminderTime.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})}</p>
          ${reminder.note ? `<p>üìù ${escapeHtml(reminder.note)}</p>` : ''}
          <p style="color: #667eea; font-weight: bold;">‚è≥ ${hoursLeft}j ${minutesLeft}m lagi</p>
          <button class="btn btn-danger" onclick="deleteReminder(${reminder.id})">Hapus</button>
        </div>
      `;
    }).join('');
  }

  window.deleteReminder = function(id) {
    if (!ensureAuth()) return;
    const r = reminders.find(x => x.id === id);
    if (!r) return;
    if (reminderTimeouts.has(id)) {
      clearTimeout(reminderTimeouts.get(id));
      reminderTimeouts.delete(id);
    }
    reminders = reminders.filter(x => x.id !== id);
    syncToUserData();
    displayReminders();
  };

  function addNote() {
    if (!ensureAuth()) return;
    const subject = document.getElementById('noteSubject').value.trim();
    const content = document.getElementById('noteContent').value.trim();
    const date = document.getElementById('noteDate').value;

    if (!subject || !content || !date) {
      alert('Mohon lengkapi semua field!');
      return;
    }

    notes.push({ id: Date.now(), subject, content, date });
    syncToUserData();
    displayNotes();

    document.getElementById('noteSubject').value = '';
    document.getElementById('noteContent').value = '';
    document.getElementById('noteDate').value = '';
  }

  function displayNotes() {
    if (!ensureAuth()) return;
    const list = document.getElementById('notesList');
    if (!notes.length) {
      list.innerHTML = '<p style="color:#999; text-align:center; padding:10px;">Belum ada catatan</p>';
      return;
    }
    list.innerHTML = notes.map(note => `
      <div class="list-item">
        <h4>${escapeHtml(note.subject)}</h4>
        <p>${escapeHtml(note.content)}</p>
        <p><small>üìÖ ${escapeHtml(note.date)}</small></p>
        <button class="btn btn-danger" onclick="deleteNote(${note.id})">Hapus</button>
      </div>
    `).join('');
  }

  window.deleteNote = function(id) {
    if (!ensureAuth()) return;
    notes = notes.filter(n => n.id !== id);
    syncToUserData();
    displayNotes();
  };

  function addStudySession() {
    if (!ensureAuth()) return;
    const subject = document.getElementById('studySubject').value.trim();
    const date = document.getElementById('studyDate').value;
    const hours = parseFloat(document.getElementById('studyHours').value);

    if (!subject || !date || !hours || isNaN(hours)) {
      alert('Mohon lengkapi semua field!');
      return;
    }
    studySessions.push({ id: Date.now(), subject, date, hours, completed: false });
    syncToUserData();
    displayStudySessions();

    document.getElementById('studySubject').value = '';
    document.getElementById('studyDate').value = '';
    document.getElementById('studyHours').value = '';
  }

  function displayStudySessions() {
    if (!ensureAuth()) return;
    const list = document.getElementById('studyList');
    if (!studySessions.length) {
      list.innerHTML = '<p style="color:#999; text-align:center; padding:10px;">Belum ada sesi belajar</p>';
      return;
    }
    list.innerHTML = studySessions.map(session => `
      <div class="list-item ${session.completed ? 'completed' : ''}">
        <h4>${escapeHtml(session.subject)}</h4>
        <p>üìÖ ${escapeHtml(session.date)} | ‚è∞ ${session.hours} jam</p>
        <p>Status: ${session.completed ? '‚úÖ Selesai' : '‚è≥ Belum Selesai'}</p>
        <button class="btn" onclick="toggleStudySession(${session.id})">${session.completed ? 'Tandai Belum Selesai' : 'Tandai Selesai'}</button>
        <button class="btn btn-danger" onclick="deleteStudySession(${session.id})">Hapus</button>
      </div>
    `).join('');
  }

  window.toggleStudySession = function(id) {
    if (!ensureAuth()) return;
    const s = studySessions.find(x => x.id === id);
    if (!s) return;
    s.completed = !s.completed;
    syncToUserData();
    displayStudySessions();
    updateReport();
  };

  window.deleteStudySession = function(id) {
    if (!ensureAuth()) return;
    studySessions = studySessions.filter(s => s.id !== id);
    syncToUserData();
    displayStudySessions();
    updateReport();
  };

  function addExpense() {
    if (!ensureAuth()) return;
    const date = document.getElementById('expenseDate').value;
    const category = document.getElementById('expenseCategory').value;
    const amount = parseFloat(document.getElementById('expenseAmount').value);

    if (!date || isNaN(amount) || amount <= 0) {
      alert('Mohon lengkapi semua field dengan benar!');
      return;
    }

    expenses.push({ id: Date.now(), date, category, amount });
    syncToUserData();
    displayExpenses();
    displayExpenseChart();

    document.getElementById('expenseDate').value = '';
    document.getElementById('expenseAmount').value = '';
    updateReport();
  }

  function displayExpenses() {
    if (!ensureAuth()) return;
    const list = document.getElementById('expenseList');
    if (!expenses.length) {
      list.innerHTML = '<p style="color:#999; text-align:center; padding:10px;">Belum ada pengeluaran</p>';
      return;
    }
    list.innerHTML = expenses.map(exp => `
      <div class="list-item">
        <h4>${escapeHtml(exp.category)}</h4>
        <p>üí∞ Rp ${formatCurrency(exp.amount)}</p>
        <p><small>üìÖ ${escapeHtml(exp.date)}</small></p>
        <button class="btn btn-danger" onclick="deleteExpense(${exp.id})">Hapus</button>
      </div>
    `).join('');
  }

  function displayExpenseChart() {
    if (!ensureAuth()) return;
    const categoryTotals = {};
    expenses.forEach(exp => {
      categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + exp.amount;
    });
    const maxAmount = Math.max(...Object.values(categoryTotals), 1);
    const chart = document.getElementById('expenseChart');
    if (!Object.keys(categoryTotals).length) {
      chart.innerHTML = '<p style="color:#999; text-align:center; padding:10px;">Belum ada data untuk chart</p>';
      return;
    }
    chart.innerHTML = Object.entries(categoryTotals).map(([cat, amount]) => `
      <div class="chart-bar">
        <span class="chart-label">${escapeHtml(cat)}</span>
        <div class="chart-bar-fill" style="width: ${(amount / maxAmount) * 300}px"></div>
        <span class="chart-value">Rp ${formatCurrency(amount)}</span>
      </div>
    `).join('');
  }

  window.deleteExpense = function(id) {
    if (!ensureAuth()) return;
    expenses = expenses.filter(e => e.id !== id);
    syncToUserData();
    displayExpenses();
    displayExpenseChart();
    updateReport();
  };

  function addTask() {
    if (!ensureAuth()) return;
    const title = document.getElementById('taskTitle').value.trim();
    const deadline = document.getElementById('taskDeadline').value;
    const difficulty = document.getElementById('taskDifficulty').value;

    if (!title || !deadline) {
      alert('Mohon lengkapi judul dan tenggat tugas!');
      return;
    }

    tasks.push({ id: Date.now(), title, deadline, difficulty, completed: false });
    syncToUserData();
    displayTasks();

    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDeadline').value = '';
    document.getElementById('taskDifficulty').value = '';
    updateReport();
  }

  function getDifficultyBadge(difficulty) {
    const badges = {
      easy: '<span class="difficulty-badge difficulty-easy">Mudah</span>',
      medium: '<span class="difficulty-badge difficulty-medium">Sedang</span>',
      hard: '<span class="difficulty-badge difficulty-hard">Sulit</span>'
    };
    return badges[difficulty] || '';
  }

  function getDifficultyHours(difficulty) {
    const hours = { easy: 1.5, medium: 3, hard: 5 };
    return hours[difficulty] || 2;
  }

  function displayTasks() {
    if (!ensureAuth()) return;
    const list = document.getElementById('tasksList');
    if (!tasks.length) {
      list.innerHTML = '<p style="color:#999; text-align:center; padding:10px;">Belum ada tugas</p>';
      return;
    }
    const sorted = [...tasks].sort((a, b) => {
      if (a.completed !== b.completed) return a.completed ? 1 : -1;
      return new Date(a.deadline) - new Date(b.deadline);
    });
    list.innerHTML = sorted.map(task => `
      <div class="list-item ${task.completed ? 'completed' : ''}">
        <h4>${escapeHtml(task.title)} ${getDifficultyBadge(task.difficulty)}</h4>
        <p>üìÖ Tenggat: ${escapeHtml(task.deadline)}</p>
        ${task.difficulty ? `<p>‚è±Ô∏è Est. waktu: ${getDifficultyHours(task.difficulty)} jam</p>` : ''}
        <p>Status: ${task.completed ? '‚úÖ Selesai' : '‚è≥ Belum Selesai'}</p>
        <button class="btn" onclick="toggleTask(${task.id})">${task.completed ? 'Tandai Belum Selesai' : 'Tandai Selesai'}</button>
        <button class="btn btn-danger" onclick="deleteTask(${task.id})">Hapus</button>
      </div>
    `).join('');
  }

  window.toggleTask = function(id) {
    if (!ensureAuth()) return;
    const t = tasks.find(x => x.id === id);
    if (!t) return;
    t.completed = !t.completed;
    syncToUserData();
    displayTasks();
    updateReport();
  };

  window.deleteTask = function(id) {
    if (!ensureAuth()) return;
    tasks = tasks.filter(t => t.id !== id);
    syncToUserData();
    displayTasks();
    updateReport();
  };

  // AUTO-SCHEDULE FEATURE
  window.generateAutoSchedule = function() {
    if (!ensureAuth()) return;
    
    const startDate = new Date(document.getElementById('scheduleStartDate').value);
    const endDate = new Date(document.getElementById('scheduleEndDate').value);
    const maxHours = parseFloat(document.getElementById('maxHoursPerDay').value);
    const sessionDuration = parseFloat(document.getElementById('sessionDuration').value);

    if (!startDate || !endDate || isNaN(maxHours) || isNaN(sessionDuration)) {
      alert('Mohon lengkapi semua field!');
      return;
    }

    if (startDate >= endDate) {
      alert('Tanggal selesai harus setelah tanggal mulai!');
      return;
    }

    const incompleteTasks = tasks.filter(t => !t.completed && t.difficulty);
    
    if (incompleteTasks.length === 0) {
      document.getElementById('autoScheduleResult').innerHTML = `
        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107;">
          <h3 style="color: #856404;">‚ÑπÔ∏è Tidak Ada Tugas</h3>
          <p style="color: #856404;">Tidak ada tugas yang belum selesai dengan estimasi kesulitan. Tambahkan tugas terlebih dahulu!</p>
        </div>
      `;
      return;
    }

    // Sort tasks by deadline
    incompleteTasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));

    const schedule = [];
    let currentDate = new Date(startDate);
    let taskIndex = 0;
    let remainingHoursForTask = 0;
    let currentTask = null;

    while (currentDate <= endDate && taskIndex < incompleteTasks.length) {
      let hoursScheduledToday = 0;
      const daySchedule = [];

      while (hoursScheduledToday < maxHours && taskIndex < incompleteTasks.length) {
        if (!currentTask) {
          currentTask = incompleteTasks[taskIndex];
          remainingHoursForTask = getDifficultyHours(currentTask.difficulty);
        }

        const hoursToSchedule = Math.min(
          sessionDuration,
          remainingHoursForTask,
          maxHours - hoursScheduledToday
        );

        if (hoursToSchedule > 0) {
          daySchedule.push({
            task: currentTask.title,
            hours: hoursToSchedule,
            difficulty: currentTask.difficulty
          });

          hoursScheduledToday += hoursToSchedule;
          remainingHoursForTask -= hoursToSchedule;

          if (remainingHoursForTask <= 0) {
            taskIndex++;
            currentTask = null;
          }
        } else {
          break;
        }
      }

      if (daySchedule.length > 0) {
        schedule.push({
          date: new Date(currentDate),
          sessions: daySchedule
        });
      }

      currentDate.setDate(currentDate.getDate() + 1);
    }

    // Display schedule
    let html = '<h3 style="color: #667eea; margin-bottom: 20px;">üìÖ Jadwal Belajar Otomatis</h3>';
    
    if (taskIndex < incompleteTasks.length) {
      html += `
        <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
          <strong>‚ö†Ô∏è Perhatian:</strong> Tidak semua tugas bisa dijadwalkan dalam periode yang dipilih. 
          ${incompleteTasks.length - taskIndex} tugas tersisa.
        </div>
      `;
    } else {
      html += `
        <div style="background: #d4edda; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #28a745;">
          <strong>‚úÖ Sukses:</strong> Semua tugas berhasil dijadwalkan!
        </div>
      `;
    }

    schedule.forEach(day => {
      const totalHours = day.sessions.reduce((sum, s) => sum + s.hours, 0);
      html += `
        <div class="time-slot">
          <h4 style="color: #3498db; margin-bottom: 10px;">
            üìÜ ${day.date.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
          </h4>
          <p style="color: #7f8c8d; margin-bottom: 10px;">Total: ${totalHours} jam</p>
          ${day.sessions.map((session, idx) => `
            <div style="background: white; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 3px solid #667eea;">
              <strong>Sesi ${idx + 1}:</strong> ${escapeHtml(session.task)} ${getDifficultyBadge(session.difficulty)}
              <span style="color: #7f8c8d; margin-left: 10px;">‚è∞ ${session.hours} jam</span>
            </div>
          `).join('')}
        </div>
      `;
    });

    html += `
      <button class="btn btn-success" onclick="saveScheduleToSessions()" style="margin-top: 20px;">
        üíæ Simpan ke Study Planner
      </button>
    `;

    document.getElementById('autoScheduleResult').innerHTML = html;

    // Store schedule temporarily for saving
    window.tempSchedule = schedule;
  };

  window.saveScheduleToSessions = function() {
    if (!window.tempSchedule) return;
    
    window.tempSchedule.forEach(day => {
      day.sessions.forEach(session => {
        studySessions.push({
          id: Date.now() + Math.random(),
          subject: session.task,
          date: day.date.toISOString().split('T')[0],
          hours: session.hours,
          completed: false
        });
      });
    });

    syncToUserData();
    alert('Jadwal berhasil disimpan ke Study Planner!');
    displayStudySessions();
    window.tempSchedule = null;
  };

  // GPA CALCULATOR FEATURE
  let gpa–°ourses = [];

  function initGPACalculator() {
    gpa–°ourses = [];
    document.getElementById('coursesContainer').innerHTML = '';
    document.getElementById('gpaResult').innerHTML = '';
    addCourseRow();
  }

  window.addCourseRow = function() {
    const container = document.getElementById('coursesContainer');
    const rowId = Date.now() + Math.random();
    
    const row = document.createElement('div');
    row.className = 'course-row';
    row.id = `course-${rowId}`;
    row.style.marginBottom = '15px';
    row.innerHTML = `
      <input type="text" placeholder="Nama Mata Kuliah" class="course-name" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
      <input type="number" placeholder="SKS" min="1" max="6" class="course-credits" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
      <select class="course-grade" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
        <option value="">Pilih Nilai</option>
        <option value="4.0">A (4.0)</option>
        <option value="3.7">A- (3.7)</option>
        <option value="3.3">B+ (3.3)</option>
        <option value="3.0">B (3.0)</option>
        <option value="2.7">B- (2.7)</option>
        <option value="2.3">C+ (2.3)</option>
        <option value="2.0">C (2.0)</option>
        <option value="1.7">C- (1.7)</option>
        <option value="1.3">D+ (1.3)</option>
        <option value="1.0">D (1.0)</option>
        <option value="0.0">E (0.0)</option>
      </select>
    `;
    
    container.appendChild(row);
  };

  window.calculateGPA = function() {
    const rows = document.querySelectorAll('.course-row');
    const courses = [];
    
    rows.forEach(row => {
      const name = row.querySelector('.course-name').value.trim();
      const credits = parseInt(row.querySelector('.course-credits').value);
      const grade = parseFloat(row.querySelector('.course-grade').value);
      
      if (name && credits && !isNaN(grade)) {
        courses.push({ name, credits, grade });
      }
    });

    if (courses.length === 0) {
      alert('Mohon tambahkan minimal satu mata kuliah dengan data lengkap!');
      return;
    }

    const totalCredits = courses.reduce((sum, c) => sum + c.credits, 0);
    const totalPoints = courses.reduce((sum, c) => sum + (c.credits * c.grade), 0);
    const gpa = (totalPoints / totalCredits).toFixed(2);

    let status = '';
    let statusColor = '';
    if (gpa >= 3.5) {
      status = 'Cumlaude üåü';
      statusColor = '#27ae60';
    } else if (gpa >= 3.0) {
      status = 'Sangat Memuaskan üëç';
      statusColor = '#3498db';
    } else if (gpa >= 2.5) {
      status = 'Memuaskan üëå';
      statusColor = '#f39c12';
    } else {
      status = 'Perlu Ditingkatkan üí™';
      statusColor = '#e74c3c';
    }

    const resultHTML = `
      <div class="gpa-result">
        <h3>IPK Semester Anda</h3>
        <h2>${gpa}</h2>
        <p style="font-size: 1.2em; margin-top: 10px;">${status}</p>
        <p style="font-size: 0.9em; margin-top: 15px; opacity: 0.9;">
          Total SKS: ${totalCredits} | Total Nilai: ${totalPoints.toFixed(2)}
        </p>
      </div>
      <div style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
        <h4 style="color: #667eea; margin-bottom: 15px;">Detail Mata Kuliah:</h4>
        ${courses.map(c => `
          <div style="padding: 10px; margin: 5px 0; background: white; border-radius: 5px; border-left: 3px solid #667eea;">
            <strong>${escapeHtml(c.name)}</strong><br>
            <span style="color: #7f8c8d;">SKS: ${c.credits} | Nilai: ${c.grade}</span>
          </div>
        `).join('')}
      </div>
    `;

    document.getElementById('gpaResult').innerHTML = resultHTML;
  };

  window.clearGPAForm = function() {
    if (confirm('Yakin ingin menghapus semua data?')) {
      initGPACalculator();
    }
  };

  function updateReport() {
    if (!ensureAuth()) return;
    const totalHours = studySessions.reduce((sum, s) => sum + (parseFloat(s.hours) || 0), 0);
    const completedTasks = tasks.filter(t => t.completed).length;
    const totalTasks = tasks.length;
    const totalExpense = expenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
    const completedSessions = studySessions.filter(s => s.completed).length;
    const productivity = studySessions.length ? ((completedSessions / studySessions.length) * 100).toFixed(1) : 0;

    document.getElementById('reportStats').innerHTML = `
      <div class="stat-card">
        <h3>‚è∞ ${totalHours}</h3>
        <p>Total Jam Belajar</p>
      </div>
      <div class="stat-card">
        <h3>‚úÖ ${completedTasks}/${totalTasks}</h3>
        <p>Tugas Selesai</p>
      </div>
      <div class="stat-card">
        <h3>üí∞ ${formatCurrency(totalExpense)}</h3>
        <p>Total Pengeluaran (Rp)</p>
      </div>
      <div class="stat-card">
        <h3>üìä ${productivity}%</h3>
        <p>Produktivitas</p>
      </div>
    `;
  }

  function saveSettings() {
    if (!ensureAuth()) return;
    const userName = document.getElementById('userName').value.trim();
    const currency = document.getElementById('currency').value;
    users[currentUser].name = userName || users[currentUser].name;
    users[currentUser].settings = users[currentUser].settings || {};
    users[currentUser].settings.currency = currency;
    saveUsersToStorage();
    document.getElementById('userGreeting').textContent = `Halo, ${users[currentUser].name}! üëã`;
    alert('Pengaturan berhasil disimpan!');
  }

  function backupData() {
    if (!ensureAuth()) return;
    const data = {
      meta: { user: currentUser, name: users[currentUser].name, timestamp: new Date().toISOString() },
      data: users[currentUser].data || {}
    };
    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `campus-life-backup-${currentUser}.json`;
    a.click();
    URL.revokeObjectURL(url);
    alert('Backup berhasil diunduh!');
  }

  function clearAllData() {
    if (!ensureAuth()) return;
    if (confirm('Yakin ingin menghapus semua data akunmu? Tindakan ini tidak dapat dibatalkan!')) {
      notes = [];
      studySessions = [];
      expenses = [];
      tasks = [];
      reminders = [];
      // clear scheduled reminders
      reminderTimeouts.forEach(id => clearTimeout(id));
      reminderTimeouts.clear();
      syncToUserData();
      showMain();
      displayNotes(); displayStudySessions(); displayExpenses(); displayTasks(); displayReminders(); updateReport();
      alert('Semua data akun berhasil dihapus!');
    }
  }

  // ---------- Utilities: safe HTML escape ----------
  function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  // ---------- Init on load ----------
  // Expose certain functions to global scope because HTML uses inline onclick
  window.register = register;
  window.login = login;
  window.logout = logout;
  window.showLogin = showLogin;
  window.showRegister = showRegister;
  window.showMain = showMain;
  window.showSection = showSection;
  window.showSubSection = showSubSection;

  window.addNote = addNote;
  window.addStudySession = addStudySession;
  window.addExpense = addExpense;
  window.addTask = addTask;
  window.addReminder = addReminder;

  window.saveSettings = saveSettings;
  window.backupData = backupData;
  window.clearAllData = clearAllData;
  window.enableNotifications = enableNotifications;

  // Ensure delete/toggle functions already defined (they were attached earlier)
  // (deleteNote, deleteStudySession, deleteExpense, deleteTask, toggleTask, toggleStudySession, deleteReminder)

  // Run initial auth check when file loads
  document.addEventListener('DOMContentLoaded', () => {
    // If currentUser is stored but user object missing, clear it
    if (currentUser && !users[currentUser]) {
      currentUser = null;
      localStorage.removeItem('currentUser');
    }
    checkAuth();
  });

})();

    </script>
</body>
</html>


